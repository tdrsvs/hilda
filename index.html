<html dir="rtl" lang="ar">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   ديار المعجبين - هيلدا الشجاعة
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&amp;display=swap" rel="stylesheet"/>
  <style>
   body {
     #dontShowAgainCheckbox,
#dontShowAgainCheckbox + span {
  display: none !important;
  pointer-events: none !important;
  user-select: none !important;
}

#dontShowAgainCheckbox {
  pointer-events: none !important;
  opacity: 0 !important;
  position: absolute !important;
  left: -9999px !important;
}
      font-family: 'Cairo', sans-serif;
      background-color: #121212;
      color: white;
    }
    /* Scrollbar for comments */
    #anonComment_list {
      max-height: 300px;
      overflow-y: auto;
    }
    /* Spoiler cursor pointer */
    .spoiler-warning {
      cursor: pointer;
    }
    /* Hide scrollbar for webkit browsers */
    #anonComment_list::-webkit-scrollbar {
      width: 6px;
    }
    #anonComment_list::-webkit-scrollbar-thumb {
      background-color: #ff6f61;
      border-radius: 3px;
    }
    /* Hide scrollbar for Firefox */
    #anonComment_list {
      scrollbar-width: thin;
      scrollbar-color: #ff6f61 transparent;
    }
    /* Seasons slider */
    .season-slider {
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      overflow-x: auto;
      display: flex;
      gap: 0.75rem;
      padding-bottom: 0.5rem;
    }
    .season-slider > button {
      scroll-snap-align: start;
      flex: 0 0 auto;
    }
    /* Focus outline for spoiler */
    .spoiler-warning:focus {
      outline: 2px solid #ff6f61;
      outline-offset: 2px;
    }
    /* Suggestions slider */
    .suggestions-slider {
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      overflow-x: auto;
      display: flex;
      gap: 1rem;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }
    .suggestion-item {
      scroll-snap-align: start;
      flex: 0 0 auto;
      background-color: #1f2937;
      border-radius: 0.5rem;
      overflow: hidden;
      width: 120px;
      cursor: pointer;
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .suggestion-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid #374151;
    }
    .suggestion-title {
      padding: 0.5rem 0.75rem;
      font-weight: 600;
      color: #f97316;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
    }
    .suggestion-item:hover, .suggestion-item:focus {
      transform: scale(1.05);
      outline: none;
    }
    /* Save position modal */
    #savePositionModal {
      background-color: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(5px);
    }
    /* Popup styles */
    .popup-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(3px);
      z-index: 60;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    .popup-content {
      background-color: #1f2937;
      border-radius: 0.5rem;
      max-width: 320px;
      width: 100%;
      padding: 1.5rem;
      text-align: center;
      color: white;
      box-shadow: 0 0 15px rgba(255,111,97,0.7);
      position: relative;
    }
    .popup-content p {
      margin-bottom: 1.5rem;
      font-weight: 600;
      font-size: 1.125rem;
      color: #f97316;
    }
    .popup-close-btn {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: transparent;
      border: none;
      color: #f97316;
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .popup-close-btn:hover, .popup-close-btn:focus {
      color: #ff6f61;
      outline: none;
    }
    /* Pages modals */
    .page-modal {
      background-color: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(5px);
      position: fixed;
      inset: 0;
      z-index: 70;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    .page-content {
      background-color: #1f2937;
      border-radius: 0.5rem;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      color: white;
      position: relative;
      text-align: right;
      font-size: 1rem;
      line-height: 1.5;
    }
    .page-close-btn {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: transparent;
      border: none;
      color: #f97316;
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .page-close-btn:hover, .page-close-btn:focus {
      color: #ff6f61;
      outline: none;
    }
    /* Verified icon styling */
    .verified-icon {
      display: inline-flex;
      align-items: center;
      margin-left: 4px;
    }
  </style>
 </head>
 <body class="min-h-screen flex flex-col">
  <!-- Header with menu icon, back icon, and social icons -->
  <header class="flex items-center justify-between px-4 py-3 border-b border-gray-700 bg-gray-900 sticky top-0 z-40">
   <div class="flex items-center space-x-3 rtl:space-x-reverse">
    <button aria-label="فتح القائمة" class="text-gray-300 hover:text-orange-500 text-2xl focus:outline-none" id="menuBtn" type="button">
     <i class="fas fa-bars">
     </i>
    </button>
    <button aria-label="العودة" class="" id="backBtn" type="button">
     <i class="fas fa-arrow-">
     </i>
    </button>
   </div>
   <h1 class="text-white font-semibold text-lg truncate max-w-xs text-center flex items-center justify-center gap-1" id="headerUsernameContainer">
    <span id="headerUsername">ديار المعجبين</span>
    <span id="headerVerifiedIcon" class="verified-icon" style="display:none;" title="موثّق" aria-label="موثّق">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="12" fill="#3b82f6" />
        <path d="M9.5 16L6 12.5L7.4 11.1L9.5 13.2L16 6.7L17.4 8.1L9.5 16Z" fill="white"/>
      </svg>
    </span>
   </h1>
   <div class="flex space-x-3 rtl:space-x-reverse items-center">
    <a aria-label="Arrow Right" class="text-gray-300 hover:text-white text-xl" href="https://fhtoon.com">
     <i class="fas fa-arrow-right">
     </i>
    </a>
        <button aria-label="حفظ موقع المشاهدة" class="text-gray-300 hover:text-orange-500 text-xl focus:outline-none" id="savePositionBtn" title="حفظ موقع المشاهدة" type="button">
     <i class="fas fa-save">
     </i>
    </button>
    <a aria-label="Instagram" class="text-gray-300 hover:text-pink-500 text-xl" href="https://www.instagram.com/fans_home_official?igsh=MXd1M3VjZWhyODVsYw==" rel="noopener" target="_blank">
     <i class="fab fa-instagram">
     </i>
    </a>
    <a aria-label="Telegram" class="text-gray-300 hover:text-blue-400 text-xl" href="https://t.me/fans_home" rel="noopener" target="_blank">
     <i class="fab fa-telegram-plane">
     </i>
    </a>
   </div>
  </header>
  <!-- Hidden side menu -->
  <aside aria-hidden="true" aria-label="القائمة الجانبية" aria-modal="true" class="fixed inset-y-0 right-0 w-64 bg-gray-900 shadow-lg transform translate-x-full transition-transform duration-300 z-50" id="sideMenu" role="dialog">
   <div class="flex flex-col h-full p-5">
    <button aria-label="إغلاق القائمة" class="self-start text-orange-500 text-2xl mb-6 focus:outline-none" id="closeMenuBtn" type="button">
     <i class="fas fa-times">
     </i>
    </button>
    <nav class="flex flex-col space-y-4 text-right text-gray-300 text-base font-semibold">
     <button class="hover:text-orange-500 flex flex-row-reverse items-center justify-end gap-2 w-full text-right" onclick="openPage('privacy'); closeSideMenu()" type="button">
      سياسة الخصوصية
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
       <path d="M12 2L4 5v6c0 5.25 3.25 10.25 8 12 4.75-1.75 8-6.75 8-12V5l-8-3z">
       </path>
      </svg>
     </button>
     <button class="hover:text-orange-500 flex flex-row-reverse items-center justify-end gap-2 w-full text-right" onclick="openPage('terms'); closeSideMenu()" type="button">
      الشروط والأحكام
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
       <path d="M9 12h6M9 16h6M12 8h.01M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z">
       </path>
      </svg>
     </button>
     <button class="hover:text-orange-500 flex flex-row-reverse items-center justify-end gap-2 w-full text-right" onclick="openPage('kids'); closeSideMenu()" type="button">
      الأسئلة الشائعة
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
       <path d="M12 18h.01M12 14a4 4 0 10-4-4h.01a4 4 0 104 4z">
       </path>
      </svg>
     </button>
    
    </nav>
   </div>
  </aside>
  <!-- Overlay for side menu -->
  <div aria-hidden="true" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" id="menuOverlay">
  </div>
  <!-- Main content container -->
  <main class="flex-grow px-4 py-3 max-w-4xl mx-auto w-full">
   <div class="w-full aspect-video bg-black rounded-md overflow-hidden shadow-lg block md:hidden">
    <img alt="" class="w-full h-full object-cover" src="https://s01.babup.com/uploads/AAAABYJ-BRd2wJms-KiMK9TUMmrzCiLzx-AtM-wreT2lGYUFdUt6Jii4WrdVzYLRSsi2XlSLLXOL5nQdCd7pnVKridDOrkKEI9BwjXQa.jpg"/>
   </div>
   <!-- Video Player Section -->
   <section>
    <h1 class="mt-3 text-lg md:text-2xl font-semibold truncate" id="seasonTitle">
     هيلدا الشجاعة | <span id="seasonStatusText">+9</span>
    </h1>
    <p class="text-gray-400 text-sm mt-1" id="seasonDescription">
      تكتشف هيلدا الجريئة والمفعمة بالحيويّة صداقات جديدة ومغامرات ومخلوقات سحريّة عندما تُغادر منزلها الساحر في الغابة مُتّجهة نحو المدينة
    </p>
   </section>
   <!-- Seasons slider -->
   <section class="mt-6">
    <h2 class="text-white text-xl font-semibold mb-2">
     المواسم
    </h2>
    <div aria-label="شريط تمرير المواسم" class="season-slider" id="seasonsSlider" tabindex="0">
    </div>
    <!-- Episodes list for selected season -->
    <ul aria-label="قائمة الحلقات" class="mt-4 space-y-3" id="episodesList" role="list">
    </ul>
    <!-- Watched selection footer -->
    <div id="watchedSelectionFooter" class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-orange-500 p-3 flex justify-between items-center space-x-3 rtl:space-x-reverse z-50 hidden max-w-4xl mx-auto px-4">
      <div class="text-orange-400 font-semibold" id="watchedCountText">0 حلقة محددة</div>
      <button id="markWatchedBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" type="button">تحديد كـ مشاهدة</button>
      <button id="cancelWatchedBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" type="button">إلغاء</button>
    </div>
   </section>
   <!-- Save Position Modal -->
   <div class="fixed inset-0 flex items-center justify-center hidden z-50 p-4" id="savePositionModal">
    <div class="bg-gray-900 rounded-lg shadow-lg max-w-md w-full p-6 text-right">
     <h3 class="text-xl font-semibold mb-4 text-orange-500">
      تذكير في اكمال الحلقة
     </h3>
     <form class="space-y-4" id="savePositionForm">
      <div>
       <label class="block mb-1" for="saveSeason">
        اختر الموسم
       </label>
       <select class="w-full p-2 rounded-md bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" id="saveSeason" required="">
       </select>
      </div>
      <div>
       <label class="block mb-1" for="saveEpisode">
        اختر الحلقة
       </label>
       <select class="w-full p-2 rounded-md bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" id="saveEpisode" required="">
       </select>
      </div>
      <div>
       <label class="block mb-1" for="saveTime">
        الوقت (ساعة:دقيقة)
       </label>
       <input class="w-full p-2 rounded-md bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" id="saveTime" pattern="^([0-9]{1,2}):([0-5][0-9])$" placeholder="مثلاً 09:00" required="" type="text"/>
      </div>
      <div class="flex justify-between items-center">
       <label class="text-gray-400 text-sm cursor-pointer flex items-center space-x-2 rtl:space-x-reverse select-none">
         <input type="checkbox" id="dontShowAgainCheckbox" class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-orange-500 focus:ring-orange-500"/>
         <span>عدم عرض هذا مجددا</span>
       </label>
       <div class="flex space-x-2 rtl:space-x-reverse">
         <button class="px-4 py-2 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors text-white font-semibold" id="cancelSavePosition" type="button">
          إلغاء
         </button>
         <button class="px-4 py-2 rounded-md bg-orange-500 hover:bg-orange-600 transition-colors text-white font-semibold" type="submit">
          حفظ
         </button>
       </div>
      </div>
     </form>
    </div>
   </div>
   <!-- Saved Position Alert -->
   <div aria-atomic="true" aria-live="assertive" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900 bg-opacity-90 border border-orange-500 rounded-md px-6 py-4 flex items-center space-x-4 rtl:space-x-reverse z-50 max-w-md w-full mx-4 hidden" id="savedPositionAlert" role="alert">
    <div class="flex-1 text-right text-orange-400 font-semibold" id="savedPositionText">
    </div>
    <button class="text-white bg-orange-500 hover:bg-orange-600 rounded-md px-4 py-1 font-semibold focus:outline-none focus:ring-2 focus:ring-orange-500" id="savedPositionOkBtn">
     حسناً
    </button>
   </div>
   <!-- Suggestions slider -->
   <section aria-label="مقترحات" class="mt-8">
    <h2 class="text-white text-xl font-semibold mb-3">
     قد يعجبك ايضا
    </h2>
    <div aria-label="شريط تمرير المقترحات" class="suggestions-slider" id="suggestionsSlider" tabindex="0">
     <a aria-label="1" class="suggestion-item focus:outline-none" href="https://alok.fhtoon.com/" tabindex="0">
      <img alt="صورة غلاف مسلسل اسطورة كورا، تظهر شخصية كورا في وضعية قتالية مع خلفية ملونة" class="suggestion-image" height="200" src="https://s01.babup.com/uploads/MV5BNzI0YmExMWYtZTY4Yy00OWVlLWFhYzEtMjEwNDBkOGQ3YjJjXkEyXkFqcGc-V1-FMjpg-UX1000-.jpg" width="120"/>
      <div class="suggestion-title">
       اسطورة كورا
      </div>
     </a>
     <a aria-label="2" class="suggestion-item focus:outline-none" href="https://sa.fhtoon.com/" tabindex="0">
      <img alt="صورة غلاف مسلسل الأكادمية، تظهر مجموعة من الطلاب في بيئة مدرسية مع ألوان زاهية" class="suggestion-image" height="200" src="https://s01.babup.com/uploads/p20540334-i-v9-aa-1-.jpg" width="120"/>
      <div class="suggestion-title">
       الأكادمية
      </div>
     </a>
     <a aria-label="3" class="suggestion-item focus:outline-none" href="https://onward.fhtoon.com/" tabindex="0">
      <img alt="صورة غلاف مسلسل الشقيقان، تظهر شخصيتين شابين في مغامرة مع خلفية غابة" class="suggestion-image" height="200" src="https://s01.babup.com/uploads/MV5BODYyM2I0YTItODA2MC00NDc0LTgyZmEtODM1MWQwZmY4YzY4XkEyXkFqcGc-V1-_13029.jpg" width="120"/>
      <div class="suggestion-title">
       الشقيقان
      </div>
     </a>
     <a aria-label="4" class="suggestion-item focus:outline-none" href="https://gf.fhtoon.com/" tabindex="0">
      <img alt="صورة غلاف مسلسل غرافيتي فولز، تظهر شخصيات كرتونية في غابة مع ألوان داكنة" class="suggestion-image" height="200" src="https://s01.babup.com/uploads/MV5BMTEzNDc3MDQ2NzNeQTJeQWpwZ15BbWU4MDYzMzUwMDIx-V1-FMjpg-UX1000-_d0c4b.jpg" width="120"/>
      <div class="suggestion-title">
       غرافيتي فولز
      </div>
     </a>
    </div>
    <script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("suggestionsSlider");
    if (!container) return;
    const scrollPos = container.scrollLeft;

      const items = Array.from(container.children);
       for (let i = items.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [items[i], items[j]] = [items[j], items[i]];
    }

      container.innerHTML = "";
    items.forEach(item => container.appendChild(item));

     container.scrollLeft = scrollPos;
  });
</script>
   </section>
   <!-- Comments Section -->
   <section class="comments-section mt-10">
    <h3 class="text-xl font-semibold mb-3">
     التعليقات
    </h3>
    <div class="mb-4">
     <textarea aria-label="اكتب تعليقك هنا" class="w-full p-3 rounded-md bg-gray-800 text-white resize-none h-24 focus:outline-none focus:ring-2 focus:ring-orange-500" id="anonComment_input" placeholder=" اكتب تعليقك هنا..."></textarea>
     <div class="mt-3 hidden" id="anonComment_country_container">
      <label class="block mb-1 text-gray-300" for="anonComment_country">
       من أي دولة أنت؟
      </label>
      <select aria-label="اختر دولتك" class="w-full p-2 rounded-md bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" id="anonComment_country">
       <option value="السعودية">
        السعودية
       </option>
       <option value="مصر">
        مصر
       </option>
       <option value="الجزائر">
        الجزائر
       </option>
       <option value="العراق">
        العراق
       </option>
       <option value="سوريا">
        سوريا
       </option>
       <option value="المغرب">
        المغرب
       </option>
       <option value="الأردن">
        الأردن
       </option>
       <option value="تونس">
        تونس
       </option>
       <option value="الإمارات">
        الإمارات
       </option>
       <option value="اليمن">
        اليمن
       </option>
       <option value="لبنان">
        لبنان
       </option>
       <option value="فلسطين">
        فلسطين
       </option>
       <option value="الكويت">
        الكويت
       </option>
       <option value="عمان">
        عمان
       </option>
       <option value="البحرين">
        البحرين
       </option>
       <option value="قطر">
        قطر
       </option>
       <option value="موريتانيا">
        موريتانيا
       </option>
       <option value="السودان">
        السودان
       </option>
       <option value="الصومال">
        الصومال
       </option>
       <option value="جيبوتي">
        جيبوتي
       </option>
       <option value="جزر القمر">
        جزر القمر
       </option>
       <option value="ليبيا">
        ليبيا
       </option>
      </select>
     </div>
     <div class="flex items-center mt-3 space-x-3 rtl:space-x-reverse">
      <input class="w-4 h-4" id="anonComment_spoiler" type="checkbox"/>
      <label class="text-gray-300 whitespace-nowrap" for="anonComment_spoiler">
       هل التعليق يحتوي على حرق لإحداث الكرتون؟
      </label>
     </div>
     <button class="mt-4 w-full bg-orange-500 hover:bg-orange-600 transition-colors rounded-md py-2 font-semibold text-white" id="anonComment_submit_btn" type="button">
      نشر التعليق
     </button>
    </div>
    <ul class="space-y-4" id="anonComment_list">
    </ul>
   </section>
  </main>

  <!-- Popup container for paid/free download info -->
  <div id="downloadPopup" class="popup-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="popupTitle" aria-describedby="popupDesc">
    <div class="popup-content">
      <button aria-label="إغلاق النافذة" class="popup-close-btn" id="popupCloseBtn" type="button">&times;</button>
      <p id="popupDesc" class="mb-6"></p>
      <button id="popupActionBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-6 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></button>
    </div>
  </div>

  <!-- Report Episode Modal -->
  <div id="reportEpisodeModal" class="popup-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle" aria-describedby="reportModalDesc">
    <div class="popup-content text-right">
      <button aria-label="إغلاق النافذة" class="popup-close-btn" id="reportCloseBtn" type="button">&times;</button>
      <h2 id="reportModalTitle" class="text-orange-500 font-semibold text-lg mb-4">   إعدادات الحلقة | وحدة التحكم </h2>
      <form id="reportForm" class="space-y-4 text-white">
        <fieldset class="space-y-2">
     
          <div>
            <input type="radio" id="issueNotWorking" name="reportReason" value="الحلقة لا تعمل" class="w-4 h-4 align-middle" required>
            <label for="issueNotWorking" class="mr-2 cursor-pointer select-none">الحلقة لا تعمل</label>
          </div>
          <div>
            <input type="radio" id="issueTranslation" name="reportReason" value="خطأ في الترجمة" class="w-4 h-4 align-middle" required>
            <label for="issueTranslation" class="mr-2 cursor-pointer select-none">خطأ في الترجمة</label>
          </div>
          <div>
            <input type="radio" id="issueDubbing" name="reportReason" value="خطأ في الدبلجة الصوت" class="w-4 h-4 align-middle" required>
            <label for="issueDubbing" class="mr-2 cursor-pointer select-none">خطأ في الدبلجة الصوت</label>
          </div>
          <div>
         
          </div>
        </fieldset>
        <div class="flex justify-between items-center">
          <button type="button" id="reportCancelBtn" class="px-4 py-2 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors text-white font-semibold focus:outline-none focus:ring-2 focus:ring-orange-500">إلغاء</button>
          <button type="submit" class="px-4 py-2 rounded-md bg-orange-500 hover:bg-orange-600 transition-colors text-white font-semibold focus:outline-none focus:ring-2 focus:ring-orange-500">التالي</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Privacy Page -->
  <div id="privacy" class="page-modal hidden" role="dialog" aria-modal="true" aria-labelledby="privacyTitle" aria-describedby="privacyDesc">
    <div class="page-content">
      <button aria-label="إغلاق سياسة الخصوصية" class="page-close-btn" onclick="closePage('privacy')" type="button">&times;</button>
      <h2 id="privacyTitle" class="text-orange-500 font-semibold text-xl mb-4">سياسة الخصوصية</h2>
      <p id="privacyDesc" class="whitespace-pre-line">
        خصوصيتك مهمة بالنسبة لنا في "ديار المعجبين"، ونحن ملتزمون بحماية أي معلومات قد يتم جمعها أثناء استخدامك لموقعنا. عند تصفحك للموقع، قد يتم جمع بعض البيانات العامة مثل عنوان IP، نوع المتصفح، الجهاز المستخدم، والصفحات التي يتم زيارتها لأغراض تحليلية فقط بهدف تحسين تجربة المستخدم وتطوير الموقع. مع ذلك، ومع إطلاق نظام تسجيل الدخول، قد نقوم بجمع بيانات شخصية مثل البريد الإلكتروني وبيانات الحساب الأخرى التي تقدمها عند التسجيل، بالإضافة إلى حفظ القوائم التي تختارها مثل المفضلة والمشاهدة لاحقًا، وذلك لتخصيص تجربتك داخل الموقع. يعتمد الموقع أيضاً على ملفات تعريف الارتباط لتحسين الأداء وتوفير تجربة استخدام سلسة، حيث تساعد هذه الملفات في تحسين سرعة التحميل، حفظ بعض الإعدادات المؤقتة، وجمع بيانات إحصائية عن كيفية استخدام الموقع. يمكن للمستخدمين تعطيل ملفات تعريف الارتباط من خلال إعدادات المتصفح، لكن ذلك قد يؤثر على بعض ميزات الموقع. نلتزم بحماية جميyع البيانات التي يتم جمعها من خلال تدابير أمنية مناسبة، مع العلم أن أي عملية نقل بيانات عبر الإنترنت لا يمكن أن تكون آمنة بالكامل، لذلك ننصح المستخدمين بعدم مشاركة أي بيانات حساسة أثناء التصفح. لا يتحمل الموقع مسؤولية أي روابط خارجية قد يتم إدراجها، حيث أن تلك المواقع تخضع لسياسات خصوصية مختلفة، ونشجع المستخدمين على مراجعة تلك السياسات قبل التفاعل معها. نحتفظ بالحق في تعديل أو تحديث سياسة الخصوصية هذه في أي وقت وفقًا لاحتياجات الموقع، وسيتم نشر أي تغييرات هنا فور تنفيذها، ويعتبر استمرارك في استخدام الموقع بعد التعديلات موافقة ضمنية على السياسة الجديدة


إذا كان لديك أي أسئلة حول سياسة الخصوصية، يرجى التواصل معنا عبر البريد الإلكتروني thehomefans@gmail.com

Last updated, jun 8st 2025
      </p>
    </div>
  </div>

  <!-- Terms Page -->
  <div id="terms" class="page-modal hidden" role="dialog" aria-modal="true" aria-labelledby="termsTitle" aria-describedby="termsDesc">
    <div class="page-content">
      <button aria-label="إغلاق الشروط والأحكام" class="page-close-btn" onclick="closePage('terms')" type="button">&times;</button>
      <h2 id="termsTitle" class="text-orange-500 font-semibold text-xl mb-4">الشروط والأحكام</h2>
      <p id="termsDesc" class="whitespace-pre-line">
        أهلاً بك في "ديار المعجبين"، نحن سعداء باستخدامك لموقعنا ونتمنى أن نقدم لك تجربة ممتعة وآمنة أثناء تصفحك ومشاهدتك للمحتوى المعروض. باستخدامك لهذا الموقع، فإنك توافق ضمنيًا على جميع الشروط والأحكام الموضحة هنا. إذا كنت لا توافق على أي جزء من هذه الشروط، نرجو منك عدم استخدام الموقع. نحن نوفر لك محتوى كرتوني يُعرض عبر روابط خارجية مع إمكانية التفاعل معه من خلال ميزات مثل إنشاء قائمة مفضلة أو المشاهدة لاحقًا، وهي خدمات قد تتطلب تسجيل دخول باستخدام بريدك الإلكتروني. إن تسجيلك في الموقع يعني أنك تقدم لنا معلومات مثل عنوان بريدك الإلكتروني وبعض البيانات المتعلقة بنشاطك داخل الموقع، والتي يتم حفظها بهدف تخصيص التجربة وتحسين الأداء العام. نحن لا نطلب أي معلومات حساسة مثل الأسماء الكاملة أو العناوين أو أرقام الهواتف، ولا نشارك البيانات التي نجمعها مع أي جهة خارجية. نحاول تقديم المحتوى بأفضل جودة ممكنة، لكننا لا نضمن خلو الموقع من الأخطاء أو الانقطاعات الفنية، كما أننا غير مسؤولين عن أي ضرر مباشر أو غير مباشر قد ينتج عن استخدامك للموقع أو اعتمادك على المحتوى الموجود فيه. جميع الروابط الخارجية التي قد تظهر ضمن الموقع هي خارج نطاق سيطرتنا، ولا نتحمل مسؤولية المحتوى أو السياسات أو الممارسات الخاصة بها. نستخدم ملفات تعريف الارتباط لتحسين أداء الموقع، حفظ الإعدادات المؤقتة، وتحليل الاستخدام، ويمكنك تعطيلها من خلال إعدادات المتصفح لكن قد يؤثر ذلك على بعض وظائف الموقع. نحن لا نسمح باستخدام الموقع من قبل الأطفال دون سن 13 عامًا، وإذا تبين لنا أن أي شخص دون هذا العمر قام بتسجيل الدخول أو تقديم معلومات، فسيتم حذف هذه البيانات فورًا. باستخدامك للموقع، فإنك تؤكد أن عمرك 13 عامًا أو أكثر. جميع الحقوق محفوظة للمالكين الأصليين للمحتوى المعروض، ولا نتحمل أي مسؤولية عن الملفات أو البيانات التي قد يتم تحميلها أو مشاركتها من قبل المستخدمين. نحتفظ بحقنا الكامل في تعديل أو تحديث هذه الشروط والأحكام في أي وقت دون إشعار مسبق، ويُعتبر استمرارك في استخدام الموقع بعد إجراء التعديلات بمثابة موافقة على الشروط الجديدة. نوصيك بمراجعة هذه الصفحة بشكل دوري للاطلاع على التحديثات
        
نحن لا نتحمل أي مسؤولية عن المحتوى الذي يتم تحميله أو مشاركته من قبل المستخدمين. جميع الحقوق محفوظة للمالكين الأصليين للمحتوى.
نحتفظ بالحق في تعديل هذه الشروط في أي وقت دون إشعار مسبق. يرجى مراجعة هذه الصفحة بانتظام  باستخدام هذا الموقع فإنك توافق على الالتزام بالشروط والأحكام المذكورة مسبقا. يرجى قراءة هذه الشروط بعناية قبل استخدام الموقع 
        
إذا كان لديك أي أسئلة حول الشروط والأحكام، يرجى التواصل معنا عبر البريد الإلكتروني thehomefans@gmail.com
   
   
   Last updated, jun 8st 2025   
        </p>
    </div>
  </div>

  <!-- FAQ Page -->
  <div id="kids" class="page-modal hidden" role="dialog" aria-modal="true" aria-labelledby="faqTitle" aria-describedby="faqDesc">
    <div class="page-content">
      <button aria-label="إغلاق الأسئلة الشائعة" class="page-close-btn" onclick="closePage('kids')" type="button">&times;</button>
      <h2 id="faqTitle" class="text-orange-500 font-semibold text-xl mb-4">الأسئلة الشائعة</h2>
      <p id="faqDesc" class="whitespace-pre-line">
        1  الحلقات والافلام والعروض لا تعمل ما السبب؟

إذا كنت تتصفح الموقع كزائر بدون تسجيل، أو حتى إذا كنت مسجل دخولك ورغم ذلك لا تعمل الحلقات أو البرامج بالشكل المطلوب، فهذا يعني غالبًا أن مزود خدمة الإنترنت الخاص بك لا يدعم الوصول الكامل إلى موقع "ديار المعجبين". في هذه الحالة، ننصحك بتثبيت تطبيق VPN وتفعيله على جهازك. بعد تفعيل الـ VPN ستتمكن من تجاوز هذا الحجب بسهولة، وتستمتع بكامل محتوى الموقع بدون أي مشاكل أو قيود


2 لم اعثر على الكرتون الذي ارغب به لِما؟

إذا لم تجد الكرتون الذي تبحث عنه، فهناك احتمالان رئيسيان. الأول وهو الأكثر شيوعًا، أن الكرتون متاح فقط للمستخدمين المسجلين، لذا يُنصح بتسجيل الدخول أو إنشاء حساب جديد باستخدام بريدك الإلكتروني واسم المستخدم وكلمة مرور من اختيارك، حتى تتمكن من الوصول الكامل لجميع الميزات والمحتوى المتاح. أما إذا قمت بتسجيل الدخول ولم تعثر على الكرتون المطلوب، فلا داعي للقلق، يمكنك ببساطة التواصل معنا عبر مركز خدمة العملاء من خلال خيار الإعدادات في الصفحة الرئيسية، حيث نتيح لك عدة طرق للتواصل مثل إنستغرام أو تيليجرام، وسنعمل على إضافته في أقرب وقت ممكن ضمن قائمة العروض



اذا كان لديك سؤال او استفستار غير مطروح اعلاه يمكنك التواصل معنا عبر البريد الالكتروني thehomefans@gmail.com 
او من الصفحة الرئيسية بالنقر على ايقونة تيليجرام او انستقرام
      </p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js">
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js">
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
   // Firebase config and initialization
const firebaseConfig = {
  apiKey: "AIzaSyC0TX35KdrVWzAnFNfpcUwA0zS3OiA0aCQ",
  authDomain: "regular-show-79b74.firebaseapp.com",
  projectId: "regular-show-79b74",
  storageBucket: "regular-show-79b74.firebasestorage.app",
  messagingSenderId: "821342810030",
  appId: "1:821342810030:web:075d3595b1904a2620623f",
  measurementId: "G-Q3K9ZBSG47"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();
const episodeKey = "hilda";

let currentUser = null;
let userWatchedEpisodes = new Set();
let currentUserData = null; // To store current user's Firestore data including username and verified

// Lock system data: add requiresPoints and pointsRequired per episode
// We'll add these properties to episodes in seasonsData below

// Centralized auth state check
firebase.auth().onAuthStateChanged(async user => {
  currentUser = user;
  if (user) {
    await loadCurrentUserData();
    await loadUserWatchedEpisodes();
    enableInteractiveFeatures();
    updateHeaderUsername();
    anonComment_render(); // Refresh comments to reflect updated username/verified
  } else {
    userWatchedEpisodes.clear();
    currentUserData = null;
    disableInteractiveFeatures();
    updateHeaderUsername();
    anonComment_render();
  }
});

// Load current user data (username, verified) from Firestore
async function loadCurrentUserData() {
  if (!currentUser) return;
  try {
    const docRef = db.collection("users").doc(currentUser.uid);
    const docSnap = await docRef.get();
    if (docSnap.exists) {
      currentUserData = docSnap.data();
    } else {
      currentUserData = null;
    }
  } catch (e) {
    console.error("Error loading current user data:", e);
    currentUserData = null;
  }
}

// Update header username and verified icon
function updateHeaderUsername() {
  const headerUsername = document.getElementById('headerUsername');
  const headerVerifiedIcon = document.getElementById('headerVerifiedIcon');
  if (currentUserData && currentUserData.username) {
    headerUsername.textContent = currentUserData.username;
    if (currentUserData.verified === true) {
      headerVerifiedIcon.style.display = 'inline-flex';
    } else {
      headerVerifiedIcon.style.display = 'none';
    }
  } else if (currentUser) {
    // fallback to email prefix
    headerUsername.textContent = currentUser.email.split('@')[0];
    headerVerifiedIcon.style.display = 'none';
  } else {
    headerUsername.textContent = 'ديار المعجبين';
    headerVerifiedIcon.style.display = 'none';
  }
}

// Load watched episodes from Firestore user document
async function loadUserWatchedEpisodes() {
  if (!currentUser) return;
  try {
    const docRef = db.collection("users").doc(currentUser.uid);
    const docSnap = await docRef.get();
    if (docSnap.exists) {
      const data = docSnap.data();
      if (data.watchedEpisodes && Array.isArray(data.watchedEpisodes)) {
        userWatchedEpisodes = new Set(data.watchedEpisodes);
      } else {
        userWatchedEpisodes = new Set();
      }
      if (data.openedLockedEpisodes && Array.isArray(data.openedLockedEpisodes)) {
        openedLockedEpisodes = new Set(data.openedLockedEpisodes);
      } else {
        openedLockedEpisodes = new Set();
      }
      if (typeof data.points === "number") {
        userPoints = data.points;
      } else {
        userPoints = 0;
      }
    } else {
      userWatchedEpisodes = new Set();
      openedLockedEpisodes = new Set();
      userPoints = 0;
    }
  } catch (e) {
    console.error("Error loading user watched episodes:", e);
    userWatchedEpisodes = new Set();
    openedLockedEpisodes = new Set();
    userPoints = 0;
  }
  // Sync local watchedEpisodes with userWatchedEpisodes
  watchedEpisodes = new Set(userWatchedEpisodes);
  renderEpisodes();
  updateUserPointsDisplay();
}

// Save watched episodes and opened locked episodes and points to Firestore user document
async function saveUserData() {
  if (!currentUser) return;
  try {
    const docRef = db.collection("users").doc(currentUser.uid);
    await docRef.set({
      watchedEpisodes: Array.from(userWatchedEpisodes),
      openedLockedEpisodes: Array.from(openedLockedEpisodes),
      points: userPoints
    }, { merge: true });
  } catch (e) {
    console.error("Error saving user data:", e);
  }
}

// Disable interactive features for guests
function disableInteractiveFeatures() {
  document.getElementById("anonComment_input").disabled = true;
  document.getElementById("anonComment_submit_btn").disabled = true;
  document.getElementById("anonComment_country_container").style.display = "none";
  document.getElementById("anonComment_input").placeholder = "سجّل دخولك أو أنشئ حسابًا مجانا لتتمكن من التعليق";
  document.getElementById("savePositionBtn").disabled = true;
  document.getElementById("anonComment_submit_btn").removeEventListener("click", anonComment_submit);
  document.getElementById("savePositionBtn").removeEventListener("click", openSavePositionModal);
  document.getElementById("anonComment_submit_btn").addEventListener("click", showLoginAlert);
  document.getElementById("savePositionBtn").addEventListener("click", showLoginAlert);
  markWatchedBtn.disabled = true;
  cancelWatchedBtn.disabled = true;
  markWatchedBtn.removeEventListener('click', markSelectedEpisodesWatched);
  cancelWatchedBtn.removeEventListener('click', exitSelectionMode);
  markWatchedBtn.addEventListener('click', showLoginAlert);
  cancelWatchedBtn.addEventListener('click', showLoginAlert);
  disableEpisodeSelection();
  disableCommentInteractionForGuests();
  updateUserPointsDisplay();
}

// Enable interactive features for logged-in users
function enableInteractiveFeatures() {
  document.getElementById("anonComment_input").disabled = false;
  document.getElementById("anonComment_submit_btn").disabled = false;
  const storedCountry = localStorage.getItem("anon_comment_country");
  if (!storedCountry) {
    document.getElementById("anonComment_country_container").style.display = "block";
  } else {
    document.getElementById("anonComment_country_container").style.display = "none";
  }
  document.getElementById("anonComment_input").placeholder = " اكتب تعليقك هنا...";
  document.getElementById("savePositionBtn").disabled = false;
  document.getElementById("anonComment_submit_btn").removeEventListener("click", showLoginAlert);
  document.getElementById("savePositionBtn").removeEventListener("click", showLoginAlert);
  document.getElementById("anonComment_submit_btn").addEventListener("click", anonComment_submit);
  document.getElementById("savePositionBtn").addEventListener("click", openSavePositionModal);
  markWatchedBtn.disabled = false;
  cancelWatchedBtn.disabled = false;
  markWatchedBtn.removeEventListener('click', showLoginAlert);
  cancelWatchedBtn.removeEventListener('click', showLoginAlert);
  markWatchedBtn.addEventListener('click', markSelectedEpisodesWatched);
  cancelWatchedBtn.addEventListener('click', exitSelectionMode);
  enableEpisodeSelection();
  enableCommentInteractionForUsers();
  updateUserPointsDisplay();
}

function showLoginAlert() {
  alert("سجّل دخولك أو أنشئ حسابًا مجانيًا لتتمكن من التعليق، حفظ تقدمك، فتح الحلقات المغلقة، وتحديد ما شاهدته.");
  window.location.href = "https://fhtoon.com/login";
}

function disableEpisodeSelection() {
  const episodesList = document.getElementById('episodesList');
  if (!episodesList) return;
  Array.from(episodesList.children).forEach(li => {
    li.style.cursor = "default";
    li.onclick = (e) => {
      e.preventDefault();
      showLoginAlert();
    };
    li.onkeypress = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        showLoginAlert();
      }
    };
  });
}

function enableEpisodeSelection() {
  renderEpisodes();
}

function disableCommentInteractionForGuests() {
  const ul = document.getElementById("anonComment_list");
  if (!ul) return;
  Array.from(ul.children).forEach(li => {
    const buttons = li.querySelectorAll("button");
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.onclick = (e) => {
        e.preventDefault();
        showLoginAlert();
      };
    });
  });
}

function enableCommentInteractionForUsers() {
  anonComment_render();
}

function anonComment_uid() {
  let uid = localStorage.getItem("anon_comment_uid");
  if (!uid) {
    uid = Date.now() + Math.random().toString(36).substring(2);
    localStorage.setItem("anon_comment_uid", uid);
  }
  return uid;
}

function anonComment_formatLikes(num) {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + "m";
  if (num >= 1000) return (num / 1000).toFixed(1) + "k";
  return num;
}

async function anonComment_submit() {
  if (!currentUser) {
    showLoginAlert();
    return;
  }
  const txt = document.getElementById("anonComment_input").value.trim();
  const spoiler = document.getElementById("anonComment_spoiler").checked;
  if (!txt) return;
  // Use currentUserData.username and verified
  const username = currentUserData && currentUserData.username ? currentUserData.username : (currentUser.email.split('@')[0]);
  const verified = currentUserData && currentUserData.verified === true;
  await db.collection("comments").doc(episodeKey).collection("items").add({
    user: username,
    userVerified: verified,
    comment: txt,
    timestamp: Date.now(),
    likes: 0,
    likedBy: [],
    owner: currentUser.uid,
    spoiler
  });
  document.getElementById("anonComment_input").value = "";
  document.getElementById("anonComment_spoiler").checked = false;
}

function anonComment_timeAgo(ts) {
  const diff = (Date.now() - ts) / 1000;
  if (diff < 60) return `منذ ${Math.floor(diff)} ثانية`;
  if (diff < 3600) return `منذ ${Math.floor(diff/60)} دقيقة`;
  if (diff < 86400) return `منذ ${Math.floor(diff/3600)} ساعة`;
  if (diff < 604800) return `منذ ${Math.floor(diff/86400)} يوم`;
  if (diff < 2592000) return `منذ ${Math.floor(diff/604800)} أسبوع`;
  return `منذ ${Math.floor(diff/2592000)} شهر`;
}

async function anonComment_like(id) {
  if (!currentUser) {
    showLoginAlert();
    return;
  }
  const uid = currentUser.uid;
  const ref = db.collection("comments").doc(episodeKey).collection("items").doc(id);
  const doc = await ref.get();
  if (!doc.exists) return;
  const d = doc.data();
  const liked = d.likedBy.includes(uid);
  await ref.update({
    likes: d.likes + (liked ? -1 : 1),
    likedBy: liked ? d.likedBy.filter(u => u !== uid) : [...d.likedBy, uid]
  });
}

async function anonComment_delete(id) {
  if (!currentUser) {
    showLoginAlert();
    return;
  }
  if (confirm("هل أنت متأكد من حذف التعليق؟")) {
    await db.collection("comments").doc(episodeKey).collection("items").doc(id).delete();
  }
}

async function anonComment_edit(id, oldComment) {
  if (!currentUser) {
    showLoginAlert();
    return;
  }
  const newText = prompt("تعديل التعليق:", oldComment);
  if (newText && newText.trim() !== "") {
    await db.collection("comments").doc(episodeKey).collection("items").doc(id).update({
      comment: newText.trim()
    });
  }
}

function anonComment_render() {
  const ul = document.getElementById("anonComment_list");
  const uid = currentUser ? currentUser.uid : anonComment_uid();
  db.collection("comments").doc(episodeKey).collection("items")
    .orderBy("likes", "desc")
    .onSnapshot(snap => {
      ul.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        const hasLiked = (d.likedBy || []).includes(uid);
        const isOwner = currentUser && d.owner === currentUser.uid;
        // If currentUserData updated username, update comments owner username and verified in Firestore
        if (currentUser && currentUserData && d.owner === currentUser.uid) {
          if (d.user !== currentUserData.username || d.userVerified !== currentUserData.verified) {
            db.collection("comments").doc(episodeKey).collection("items").doc(doc.id).update({
              user: currentUserData.username,
              userVerified: currentUserData.verified === true
            });
            d.user = currentUserData.username;
            d.userVerified = currentUserData.verified === true;
          }
        }
        const li = document.createElement("li");
        li.className = "bg-gray-800 p-3 rounded-md";
        let commentHTML = `<p id='comment-text-${doc.id}' class="whitespace-pre-wrap">${d.comment}</p>`;
        if (d.spoiler) {
          commentHTML = `<div class='spoiler-warning bg-gray-700 p-2 rounded-md text-orange-400 font-bold mb-2' onclick='this.nextElementSibling.style.display="block";this.remove();' tabindex="0" role="button" aria-label="هذا التعليق يحتوي على حرق أحداث، انقر هنا لعرض التعليق">هذا التعليق يحتوي على حرق أحداث، انقر هنا لعرض التعليق</div>
          <p style='display:none;color:#ff6f61;font-weight:bold;' class="whitespace-pre-wrap">${d.comment}</p>`;
        }
        // Verified icon for user if verified true
        let verifiedIconHTML = '';
        if (d.userVerified === true) {
          verifiedIconHTML = `<span class="verified-icon" title="موثّق" aria-label="موثّق">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="12" fill="#3b82f6" />
              <path d="M9.5 16L6 12.5L7.4 11.1L9.5 13.2L16 6.7L17.4 8.1L9.5 16Z" fill="white"/>
            </svg>
          </span>`;
        }
        li.innerHTML = `
          <strong class="text-orange-500 text-lg flex items-center justify-end gap-1">${d.user || "مستخدم مجهول"}${verifiedIconHTML}</strong><br>
          ${commentHTML}
          <div class="flex justify-between items-center mt-2">
            <span class="text-gray-400 text-sm">${anonComment_timeAgo(d.timestamp)}</span>
            <div class="flex items-center space-x-2 rtl:space-x-reverse">
              <button onclick="anonComment_like('${doc.id}')" aria-label="إعجاب بالتعليق" class="text-sm focus:outline-none" style="color:${hasLiked ? 'red' : 'white'};">&#10084; ${anonComment_formatLikes(d.likes || 0)}</button>
              ${isOwner ? `
                <button onclick="anonComment_edit('${doc.id}', \`${d.comment.replace(/`/g, "\\`")}\`)" aria-label="تعديل التعليق" class="text-sm text-gray-300 hover:text-orange-500 focus:outline-none">تعديل</button>
                <button onclick="anonComment_delete('${doc.id}')" aria-label="حذف التعليق" class="text-sm text-gray-300 hover:text-orange-500 focus:outline-none">حذف</button>
              ` : ""}
            </div>
          </div>
        `;
        ul.appendChild(li);
      });
      if (!currentUser) {
        disableCommentInteractionForGuests();
      }
    });
}

// Save Position Modal logic
const savePositionBtn = document.getElementById('savePositionBtn');
const savePositionModal = document.getElementById('savePositionModal');
const savePositionForm = document.getElementById('savePositionForm');
const saveSeasonSelect = document.getElementById('saveSeason');
const saveEpisodeSelect = document.getElementById('saveEpisode');
const saveTimeInput = document.getElementById('saveTime');
const cancelSavePositionBtn = document.getElementById('cancelSavePosition');
const savedPositionAlert = document.getElementById('savedPositionAlert');
const savedPositionText = document.getElementById('savedPositionText');
const savedPositionOkBtn = document.getElementById('savedPositionOkBtn');
const dontShowAgainCheckbox = document.getElementById('dontShowAgainCheckbox');

function openSavePositionModal() {
  if (!currentUser) {
    showLoginAlert();
    return;
  }
  populateSaveSeasons();
  populateSaveEpisodes(0);
  saveTimeInput.value = '';
  dontShowAgainCheckbox.checked = false;
  savePositionModal.classList.remove('hidden');
  saveSeasonSelect.focus();
  document.body.style.overflow = 'hidden';
}

cancelSavePositionBtn.addEventListener('click', () => {
  savePositionModal.classList.add('hidden');
  document.body.style.overflow = 'auto';
  savePositionBtn.focus();
});

savePositionForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const seasonIndex = saveSeasonSelect.value;
  const episodeIndex = saveEpisodeSelect.value;
  const time = saveTimeInput.value.trim();

  if (!time.match(/^([0-9]{1,2}):([0-5][0-9])$/)) {
    alert('يرجى إدخال التوقيت بشكل صحيح (مثلاً 09:00)');
    saveTimeInput.focus();
    return;
  }

  const season = seasonsData[seasonIndex];
  const episode = season.episodes[episodeIndex];

  const saveData = {
    seasonNumber: season.seasonNumber,
    episodeTitle: episode.title,
    time: time,
    seasonIndex: parseInt(seasonIndex),
    episodeIndex: parseInt(episodeIndex)
  };

  localStorage.setItem('savedWatchPosition', JSON.stringify(saveData));
  localStorage.setItem('dontShowSavedPositionAgain', dontShowAgainCheckbox.checked ? 'true' : 'false');

  savePositionModal.classList.add('hidden');
  document.body.style.overflow = 'auto';
  showSavedPositionAlert(saveData);
  savePositionBtn.focus();
});

function showSavedPositionAlert(data) {
  if (!currentUser) return; // Do not show alert if not logged in
  const dontShowAgain = localStorage.getItem('dontShowSavedPositionAgain') === 'true';
  if (dontShowAgain) {
    return;
  }
  savedPositionText.textContent = `توقفت عند الموسم ${data.seasonNumber} تحديدا ${data.episodeTitle} . تماما في الدقيقة ${data.time}`;
  savedPositionAlert.classList.remove('hidden');
  savedPositionOkBtn.focus();
}

savedPositionOkBtn.addEventListener('click', () => {
  savedPositionAlert.classList.add('hidden');
  savedPositionOkBtn.blur();
});

// Watched episodes tracking and selection
let watchedEpisodes = new Set();
let selectionMode = false;
let selectedEpisodes = new Set();

const watchedSelectionFooter = document.getElementById('watchedSelectionFooter');
const watchedCountText = document.getElementById('watchedCountText');
const markWatchedBtn = document.getElementById('markWatchedBtn');
const cancelWatchedBtn = document.getElementById('cancelWatchedBtn');

function updateWatchedCountText() {
  watchedCountText.textContent = `${selectedEpisodes.size} حلقة محددة`;
}

function enterSelectionMode() {
  selectionMode = true;
  selectedEpisodes.clear();
  updateWatchedCountText();
  watchedSelectionFooter.classList.remove('hidden');
  updateMarkWatchedBtnText();
}

function exitSelectionMode() {
  selectionMode = false;
  selectedEpisodes.clear();
  watchedSelectionFooter.classList.add('hidden');
  Array.from(episodesList.children).forEach(li => {
    li.classList.remove('ring-2', 'ring-orange-500');
  });
  updateSeasonStatusText();
}

function toggleEpisodeSelection(episodeId, liElement) {
  if (selectedEpisodes.has(episodeId)) {
    selectedEpisodes.delete(episodeId);
    liElement.classList.remove('ring-2', 'ring-orange-500');
  } else {
    selectedEpisodes.add(episodeId);
    liElement.classList.add('ring-2', 'ring-orange-500');
  }
  updateWatchedCountText();
  if (selectedEpisodes.size === 0) {
    exitSelectionMode();
  } else {
    updateMarkWatchedBtnText();
  }
}

function updateMarkWatchedBtnText() {
  if (selectedEpisodes.size === 0) {
    markWatchedBtn.textContent = 'تحديد كـ مُشاهدة';
    return;
  }
  let allWatched = true;
  selectedEpisodes.forEach(epId => {
    if (!userWatchedEpisodes.has(epId)) {
      allWatched = false;
    }
  });
  if (allWatched) {
    markWatchedBtn.textContent = 'إزالة من المشاهدة';
  } else {
    markWatchedBtn.textContent = 'تحديد كـ تمت المشاهدة';
  }
}

async function markSelectedEpisodesWatched() {
  if (!currentUser) {
    showLoginAlert();
    return;
  }
  if (selectedEpisodes.size === 0) return;
  let allWatched = true;
  selectedEpisodes.forEach(epId => {
    if (!userWatchedEpisodes.has(epId)) {
      allWatched = false;
    }
  });
  if (allWatched) {
    selectedEpisodes.forEach(epId => {
      userWatchedEpisodes.delete(epId);
    });
  } else {
    selectedEpisodes.forEach(epId => {
      userWatchedEpisodes.add(epId);
    });
  }
  await saveUserData();
  watchedEpisodes = new Set(userWatchedEpisodes);
  renderEpisodes();
  exitSelectionMode();
}

markWatchedBtn.addEventListener('click', markSelectedEpisodesWatched);
cancelWatchedBtn.addEventListener('click', exitSelectionMode);

// User points and locked episodes management
let userPoints = 0;
let openedLockedEpisodes = new Set();

function updateUserPointsDisplay() {
  // Show user points in header or somewhere visible
  let pointsDisplay = document.getElementById('userPointsDisplay');
  if (!pointsDisplay) {
    pointsDisplay = document.createElement('div');
    pointsDisplay.id = 'userPointsDisplay';
    pointsDisplay.className = 'text-orange-400 font-semibold text-sm mr-4 rtl:ml-4';
    const header = document.querySelector('header > div.flex.space-x-.rtl\\:space-x-reverse.items-center');
    if (header) {
      header.insertBefore(pointsDisplay, header.firstChild);
    }
  }
  if (currentUser) {
    pointsDisplay.textContent = `نقاطك: ${userPoints}`;
  } else {
    pointsDisplay.textContent = '';
  }
}

// Seasons and episodes data (example) with requiresPoints and pointsRequired added
const seasonsData = [
  {
    seasonNumber: 1,
    episodes: [
      
  { id: "s1e1", title: "الحلقة 1 الشعب المخفي", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s1e1-fans-home-fans_home-Cm7LEMHcFN_jlB0jV", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e2", title: "الحلقة 2 عملاق منتصف الليل", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e02-fans-home-fans_home-8gS8TNqroq$vofigz", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e3", title: "الحلقة 3 موكب الطيور", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e03-fans-home-fans_home-A4RAnlXarwL_3aUQn", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e4", title: "الحلقة 4 الكشّافة", duration: "مدبلجة", link: "https://videa.hu/videok/film-acio/ah-s01e04-fans-home-piLYXaqcjNW.9IYXv", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e5", title: "الحلقة 5 الترول الصخري", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e05-fans-home-Kh5mQfGWgK9Co3g8.", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e6", title: "الحلقة 6 شبح الكوابيس", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e06-fans-home-cW0B!rZkpmuFu5AKo", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e7", title: "الحلقة 7 القبيلة المفقودة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e07-fans-home-Xq7mpAdXNxxz$ONbJ", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e8", title: "الحلقة 8 الفئران السحرية", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e08-fans-home-kDrveBmp!SdGGwSxz", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e9", title: "الحلقة 9 الشبح", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e09-fans-home-K6q2Nfk_iPr9RLdsS", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e10", title: "الحلقة 10 العاصفة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e10-fans-home-aJikJocvDr2n5rmT_", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e11", title: "الحلقة 11 منزل منتصف الغابة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e11-fans-home-ZVD.pKRqKTvtV08fX", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e12", title: "الحلقة 12 ارواح الناس", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e12-fans-home-xJUL4CG.3gaURJVyZ", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e13", title: "الحلقة 13 الكلب العملاق الأسود", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s01e13-ls1-fans-home-tIbtWZSY.EAwYI3C2", requiresPoints: true, pointsRequired: 3 }

    ]
  },
  {
    seasonNumber: 2 ,
    episodes: [

  { id: "s1e1", title: "الحلقة 1 تجمع الترولز", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s02e01-fans-home-1DR!hNUJ766uyVtmO", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e2", title: "الحلقة 2 الدراوغين", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s02e02-fans-home-l0JZYNjxLpoZ!vpe1", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e3", title: "الحلقة 3 الساحرة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s02e03-i-fans-home-pCxHrJitVcq_87gH9", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e4", title: "الحلقة 4 المحاربون الأبديون", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s02e04-i-fans-home-0Jl5TGkJo0aDI_2fI", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e5", title: "الحلقة 5 الطاحونة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s2e5-mp4-fans-home-534VvAiIfhZZ9Jf.J", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e6", title: "الحلقة 6 اجراس ترول بيرغ القديمة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s02e06-fans-home-cJHV_bYMkN4Etksb9", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e7", title: "الحلقة 7 وحش جزيرة كولدرون", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s2e7-fans-home-Xc_IjgkYj8h3PZkfo", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e8", title: "الحلقة 8 ليلى الذكرى السنوية", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s2e8-fans-home-mva5ipXLa!wOCOhiO", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e9", title: "الحلقة 9 الثعلب الغزالي", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s2e9-fans-home-2GgwXMxFLvj_bDFG0", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e10", title: "الحلقة 10 فتيان اليول", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s2e10-fans-home-ioGy9D0A9VY28M.9h", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e11", title: "الحلقة 11 حادث جورتس", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s2e11-fans-home-Vu8B2z!SLH13w0iCn", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e12", title: "الحلقة 12 البديل", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s02e12-fans-home-6z075KN.dzlEH05xD", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e13", title: "الحلقة 13 غابة الحجارة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s2e13ends2-fans-home-qq9PdEWWw.YU0DXk9", requiresPoints: false, pointsRequired: 0 },
  { id: "s1e14", title: "حلقة خاصة هيلدا وملك الجبل", duration: "مترجمة", link: "https://videa.hu/videok/film-animacio/hilda-se-fans-home-MgffgYyX.X4sjXgSv", requiresPoints: true, pointsRequired: 11 }
]
  },
  {
    seasonNumber: 3 ,
    episodes: [
      
  { id: "s3e1", title: "الحلقة 1 قطار الى توفوتين", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s3e1-ah-fans-home-1oudfOrAsFLD3$ZOY", requiresPoints: false, pointsRequired: 0 },
  { id: "s3e2", title: "الحلقة 2 تل الجنيات", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s3e2-ah-fans-home-Gx7pAOwMznwn9Y9!h", requiresPoints: false, pointsRequired: 0 },
  { id: "s3e3", title: "الحلقة 3 قاتل العمالقة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s3e3-ah-fans-home-u!5GwfP38OjgOJWsL", requiresPoints: false, pointsRequired: 0 },
  { id: "s3e4", title: "الحلقة 4 عريس البحر الضاحك", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s3e4-ah-fans-home-tGQJRlrq!lEw3ceUK", requiresPoints: false, pointsRequired: 0 },
  { id: "s3e5", title: "الحلقة 5 المهمة الصخري", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s3e5-ah-fans-home-9p!ULJ16hqZpSmu65", requiresPoints: false, pointsRequired: 0 },
  { id: "s3e6", title: "الحلقة 6 البحيرة المنسية", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s3e6-ah-fans-home-RxB1iij_o4bXjPjZZ", requiresPoints: false, pointsRequired: 0 },
  { id: "s3e7", title: "الحلقة 7 ترددات غريبة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/s3e7-ah-fans-home-047R2xVQvb$LK3pth", requiresPoints: false, pointsRequired: 0 },
  { id: "s3e8", title: "الحلقة 8 جزيرة الجنيات 》 الحلقة الأخيرة", duration: "مدبلجة", link: "https://videa.hu/videok/film-animacio/ah-s3e8ends3-fans-home-TJKkRzp!mHb6TwLTo", requiresPoints: true, pointsRequired: 5}
]
  },
];

// Render seasons slider buttons
const seasonsSlider = document.getElementById('seasonsSlider');
const episodesList = document.getElementById('episodesList');
let selectedSeasonIndex = 0;

function renderSeasonsSlider() {
  seasonsSlider.innerHTML = '';
  seasonsData.forEach((season, index) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'px-4 py-2 rounded-md border border-gray-600 text-gray-300 hover:border-orange-500 hover:text-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500 whitespace-nowrap';
    btn.textContent = `الموسم ${season.seasonNumber}`;
    btn.setAttribute('aria-pressed', index === selectedSeasonIndex ? 'true' : 'false');
    if (index === selectedSeasonIndex) {
      btn.classList.add('bg-orange-600', 'border-orange-500', 'text-white');
    }
    btn.addEventListener('click', () => {
      selectedSeasonIndex = index;
      updateSeasonsSlider();
      renderEpisodes();
      exitSelectionMode();
    });
    seasonsSlider.appendChild(btn);
  });
}

function updateSeasonsSlider() {
  Array.from(seasonsSlider.children).forEach((btn, idx) => {
    if (idx === selectedSeasonIndex) {
      btn.classList.add('bg-orange-600', 'border-orange-500', 'text-white');
      btn.setAttribute('aria-pressed', 'true');
      btn.scrollIntoView({behavior: 'smooth', inline: 'center'});
    } else {
      btn.classList.remove('bg-orange-600', 'border-orange-500', 'text-white');
      btn.setAttribute('aria-pressed', 'false');
    }
  });
}

function updateSeasonStatusText() {
  const season = seasonsData[selectedSeasonIndex];
  const seasonStatusText = document.getElementById('seasonStatusText');
  if (selectionMode && selectedEpisodes.size > 0) {
    let allWatched = true;
    selectedEpisodes.forEach(epId => {
      if (!userWatchedEpisodes.has(epId)) {
        allWatched = false;
      }
    });
    if (allWatched) {
      seasonStatusText.textContent = "تمت مشاهدة هذه الحلقة";
      return;
    }
  }
  seasonStatusText.textContent = "+9";
}

// Show popup for locked episode
const downloadPopup = document.getElementById('downloadPopup');
const popupDesc = document.getElementById('popupDesc');
const popupActionBtn = document.getElementById('popupActionBtn');
const popupCloseBtn = document.getElementById('popupCloseBtn');

popupCloseBtn.addEventListener('click', () => {
  downloadPopup.classList.add('hidden');
  document.body.style.overflow = 'auto';
});

function showLockedEpisodePopup(episode) {
  popupDesc.textContent = `لفتح   ${episode.title}.  تحتاج إلى ${episode.pointsRequired} نقاط. هل تود فتح الحلقة؟`;
  popupActionBtn.textContent = `فتح الحلقة مقابل ${episode.pointsRequired} نقاط`;
  popupActionBtn.disabled = false;
  downloadPopup.classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  popupActionBtn.onclick = async () => {
    popupActionBtn.disabled = true;
    popupActionBtn.textContent = 'جاري الفتح...';
    // Wait 2 seconds
    await new Promise(resolve => setTimeout(resolve, 2000));
    if (userPoints >= episode.pointsRequired) {
      userPoints -= episode.pointsRequired;
      openedLockedEpisodes.add(episode.id);
      await saveUserData();
      updateUserPointsDisplay();
      renderEpisodes();
      alert(`تم فتح الحلقة "${episode.title}" بنجاح!`);
      downloadPopup.classList.add('hidden');
      document.body.style.overflow = 'auto';
    } else {
      alert('رصيد النقاط غير كافٍ لفتح هذه الحلقة.');
      popupActionBtn.disabled = false;
      popupActionBtn.textContent = `فتح الحلقة (${episode.pointsRequired} نقاط)`;
    }
  };
}

function renderEpisodes() {
  episodesList.innerHTML = '';
  const season = seasonsData[selectedSeasonIndex];
  season.episodes.forEach(ep => {
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center p-3 rounded-md bg-gray-800 hover:bg-gray-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-orange-500 relative';
    li.setAttribute('tabindex', '0');
    li.setAttribute('role', 'link');
    li.setAttribute('aria-label', `${ep.title} مدة ${ep.duration}`);
    li.dataset.episodeId = ep.id;

    // Determine if episode is locked and if user opened it
    const isLocked = ep.requiresPoints === true;
    const isOpened = openedLockedEpisodes.has(ep.id);

    // Mark watched episodes
    if (userWatchedEpisodes.has(ep.id)) {
      li.classList.add('bg-green-700');
    }

    const leftDiv = document.createElement('div');
    leftDiv.className = 'flex items-center space-x-3 rtl:space-x-reverse flex-1';

    // If locked and not opened, show lock icon and points required
    if (isLocked && !isOpened) {
      const lockSpan = document.createElement('span');
      lockSpan.className = 'text-orange-500 font-bold flex items-center gap-1';
      lockSpan.setAttribute('aria-label', `مقفلة، تحتاج إلى ${ep.pointsRequired} نقاط للفتح`);
      lockSpan.innerHTML = `<i class="fas fa-lock"></i> <span>${ep.pointsRequired} </span>`;
      leftDiv.appendChild(lockSpan);
    }

    const textDiv = document.createElement('div');
    textDiv.className = 'flex flex-col';

    const titleSpan = document.createElement('span');
    titleSpan.textContent = ep.title;
    titleSpan.className = 'font-semibold';

    const durationSpan = document.createElement('span');
    durationSpan.className = 'text-gray-400 text-sm mt-1';

    if (selectionMode && selectedEpisodes.has(ep.id)) {
      let allWatched = true;
      selectedEpisodes.forEach(epId => {
        if (!userWatchedEpisodes.has(epId)) {
          allWatched = false;
        }
      });
      if (allWatched) {
        durationSpan.textContent = "تمت مشاهدة هذه الحلقة √ ";
        durationSpan.style.color = "orange";
      } else {
        durationSpan.textContent = ep.duration;
      }
    } else if (userWatchedEpisodes.has(ep.id)) {
      durationSpan.textContent = "تمت مشاهدة هذه الحلقة √ ";
      durationSpan.style.color = "orange";
    } else {
      durationSpan.textContent = ep.duration;
    }

    textDiv.appendChild(titleSpan);
    textDiv.appendChild(durationSpan);

    leftDiv.appendChild(textDiv);

    li.appendChild(leftDiv);

    const reportBtn = document.createElement('button');
    reportBtn.type = 'button';
    reportBtn.className = 'text-orange-500 hover:text-orange-400 focus:outline-none ml-3 rtl:ml-0 rtl:mr-3 text-lg flex items-center';
    reportBtn.setAttribute('aria-label', 'إبلاغ عن الحلقة');
    reportBtn.innerHTML = '<i class="fas fa-ellipsis-v"></i> ';
    reportBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      openReportModal(ep, selectedSeasonIndex);
    });

    li.appendChild(reportBtn);

    li.addEventListener('click', (e) => {
      // Free episodes (requiresPoints false) are accessible to all users (even guests)
      if (isLocked) {
        // Locked episodes require login and points
        if (!currentUser) {
          showLoginAlert();
          return;
        }
        if (!isOpened) {
          showLockedEpisodePopup(ep);
          return;
        }
      }
      // For free episodes or opened locked episodes, allow access without login
      window.location.href = ep.link;
    });

    li.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        li.click();
      }
    });

    let pressTimer = null;
    const longPressDuration = 600;

    function startPressTimer() {
      if (selectionMode) return;
      pressTimer = setTimeout(() => {
        if (!currentUser) {
          showLoginAlert();
          return;
        }
        enterSelectionMode();
        toggleEpisodeSelection(ep.id, li);
        updateSeasonStatusText();
      }, longPressDuration);
    }
    function cancelPressTimer() {
      if (pressTimer !== null) {
        clearTimeout(pressTimer);
        pressTimer = null;
      }
    }

    li.addEventListener('touchstart', (e) => {
      startPressTimer();
    });
    li.addEventListener('touchend', (e) => {
      cancelPressTimer();
    });
    li.addEventListener('touchmove', (e) => {
      cancelPressTimer();
    });
    li.addEventListener('touchcancel', (e) => {
      cancelPressTimer();
    });

    li.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return;
      startPressTimer();
    });
    li.addEventListener('mouseup', (e) => {
      cancelPressTimer();
    });
    li.addEventListener('mouseleave', (e) => {
      cancelPressTimer();
    });

    episodesList.appendChild(li);
  });
  updateSeasonStatusText();
}

// Report modal logic
let currentReportEpisode = null;
let currentReportSeasonIndex = null;

function openReportModal(episode, seasonIndex) {
  currentReportEpisode = episode;
  currentReportSeasonIndex = seasonIndex;
  reportForm.reset();
  reportEpisodeModal.classList.remove('hidden');
  reportForm.reportReason[0].focus();
  document.body.style.overflow = 'hidden';
}

function closeReportModal() {
  reportEpisodeModal.classList.add('hidden');
  document.body.style.overflow = 'auto';
  currentReportEpisode = null;
  currentReportSeasonIndex = null;
}

const reportCloseBtn = document.getElementById('reportCloseBtn');
const reportCancelBtn = document.getElementById('reportCancelBtn');
const reportForm = document.getElementById('reportForm');

reportCloseBtn.addEventListener('click', () => {
  closeReportModal();
});

reportCancelBtn.addEventListener('click', () => {
  closeReportModal();
});

reportForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const selectedReason = reportForm.reportReason.value;
  if (!selectedReason) return;

  let mailtoLink = "mailto:thehomefans@gmail.com?subject=";
  let body = "";

  if (selectedReason === "") {
    body = `  ${currentReportEpisode.title}  ${seasonsData[currentReportSeasonIndex].seasonNumber}  




 `;
    mailtoLink += encodeURIComponent("");
  } else {
    body = `مرحبا ديار المعجبين أواجه مشكلة في :  ${selectedReason} الرجاء تزويدي بتفاصيل الخطأ 





قبل الإرسال يرجى كتابة إحدى حسابات الشخصية على إنستغرام أو تيليجرام  في الاسفل
تيليجرام: 
إنستغرام:
اكتب اسم الكرتون الذي تقصده:  `;
    mailtoLink += encodeURIComponent("إبلاغ عن مشكلة في الحلقة");
  }

  mailtoLink += "&body=" + encodeURIComponent(body);

  window.location.href = mailtoLink;

  closeReportModal();
});

// Close report modal on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !reportEpisodeModal.classList.contains('hidden')) {
    closeReportModal();
  }
});

// Open and close pages (privacy, terms, kids)
function openPage(id) {
  document.getElementById(id).classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  const closeBtn = document.querySelector(`#${id} .page-close-btn`);
  if (closeBtn) closeBtn.focus();
  closeSideMenu();
}
function closePage(id) {
  document.getElementById(id).classList.add('hidden');
  document.body.style.overflow = 'auto';
  document.getElementById('menuBtn').focus();
}

// Side menu open/close
const menuBtn = document.getElementById('menuBtn');
const closeMenuBtn = document.getElementById('closeMenuBtn');
const sideMenu = document.getElementById('sideMenu');
const menuOverlay = document.getElementById('menuOverlay');

function openSideMenu() {
  sideMenu.classList.remove('translate-x-full');
  sideMenu.setAttribute('aria-hidden', 'false');
  menuOverlay.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  closeMenuBtn.focus();
}
function closeSideMenu() {
  sideMenu.classList.add('translate-x-full');
  sideMenu.setAttribute('aria-hidden', 'true');
  menuOverlay.classList.add('hidden');
  document.body.style.overflow = 'auto';
  menuBtn.focus();
}

menuBtn.addEventListener('click', openSideMenu);
closeMenuBtn.addEventListener('click', closeSideMenu);
menuOverlay.addEventListener('click', closeSideMenu);

// Close side menu on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (!sideMenu.classList.contains('translate-x-full')) {
      closeSideMenu();
    }
    ['privacy', 'terms', 'kids'].forEach(id => {
      const el = document.getElementById(id);
      if (el && !el.classList.contains('hidden')) {
        closePage(id);
      }
    });
  }
});

// Back button functionality
const backBtn = document.getElementById('backBtn');
backBtn.addEventListener('click', () => {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    alert('');
  }
});

// Initial load
window.onload = function() {
  renderSeasonsSlider();
  renderEpisodes();
  anonComment_render();

  const storedCountry = localStorage.getItem("anon_comment_country");
  if (storedCountry) {
    document.getElementById("anonComment_country_container").style.display = "none";
  }

  const savedPosition = localStorage.getItem('savedWatchPosition');
  if (savedPosition && currentUser) {
    try {
      const data = JSON.parse(savedPosition);
      showSavedPositionAlert(data);
    } catch(e) {
    }
  }
};

// Populate save position modal selects
function populateSaveSeasons() {
  saveSeasonSelect.innerHTML = '';
  seasonsData.forEach((season, idx) => {
    const option = document.createElement('option');
    option.value = idx;
    option.textContent = `الموسم ${season.seasonNumber}`;
    saveSeasonSelect.appendChild(option);
  });
}

function populateSaveEpisodes(seasonIndex) {
  saveEpisodeSelect.innerHTML = '';
  const season = seasonsData[seasonIndex];
  season.episodes.forEach((ep, idx) => {
    const option = document.createElement('option');
    option.value = idx;
    option.textContent = ep.title;
    saveEpisodeSelect.appendChild(option);
  });
}

saveSeasonSelect.addEventListener('change', () => {
  populateSaveEpisodes(saveSeasonSelect.value);
});
  </script>
 </body>
</html>
